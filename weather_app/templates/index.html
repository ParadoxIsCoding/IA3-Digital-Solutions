<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather Preview</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <h1>Weather Observations</h1>
        <div id="obsGrid" class="observations-grid"></div>
        <div class="chart-container">
            <canvas id="tempChart"></canvas>
        </div>
        <div class="api-link">
            <p>View raw data: <a href="{{ url_for('api_weather') }}" target="_blank">/api/weather</a></p>
        </div>
    </div>
    <footer>
        <p>Weather data sourced from Ecowitt devices.</p>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const ctx = document.getElementById('tempChart').getContext('2d');
        const datasets = [
            { label: 'EF:E1 (째C)', data: [], borderColor: '#ff9800', backgroundColor: 'rgba(255,152,0,0.2)', tension: 0.3 },
            { label: '96:AF (째C)', data: [], borderColor: '#4fc3f7', backgroundColor: 'rgba(79,195,247,0.2)', tension: 0.3 }
        ];
        const chartData = { labels: [], datasets: datasets };
        const tempChart = new Chart(ctx, {
            type: 'line',
            data: chartData,
            options: {
                scales: {
                    x: { title: { display: true, text: 'Time' }, ticks: { color: '#e0e0e0' }, grid: { color: '#333' } },
                    y: { title: { display: true, text: 'Temperature (째C)' }, ticks: { color: '#e0e0e0' }, grid: { color: '#333' } }
                },
                plugins: { legend: { labels: { color: '#e0e0e0' } } }
            }
        });

        function fetchData() {
            fetch('{{ url_for('api_weather') }}')
                .then(r => r.json())
                .then(data => {
                    if (!data.observations) return;
                    const time = data.observations[0].time;
                    if (chartData.labels.length === 0 || chartData.labels[chartData.labels.length - 1] !== time) {
                        chartData.labels.push(time);
                        data.observations.forEach((obs, idx) => {
                            chartData.datasets[idx].data.push(obs.temp_c);
                        });
                        tempChart.update();
                    }
                    const grid = document.getElementById('obsGrid');
                    grid.innerHTML = '';
                    data.observations.forEach(obs => {
                        const card = document.createElement('div');
                        card.className = 'observation-card';
                        card.innerHTML = `<h3>${obs.mac}</h3>
                            <div class="weather-details">
                                <div class="detail-item"><span class="label">Temperature:</span><span class="value">${obs.temp_c}째C</span></div>
                                <div class="detail-item"><span class="label">Time:</span><span class="value">${obs.time}</span></div>
                            </div>`;
                        grid.appendChild(card);
                    });
                });
        }
        fetchData();
        setInterval(fetchData, 60000);
    </script>
</body>
</html>
